<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Financial Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.min.js"></script>
  <style>
    @media print {
      .no-print { display: none; }
    }
    #spinner {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.8);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #spinner.hidden { display: none; }
  </style>
</head>
<body class="bg-light">
  <div id="spinner">
    <div class="text-center">
      <div class="spinner-border text-primary" style="width: 4rem; height: 4rem;" role="status"></div>
      <div class="mt-3">Loading Dow data...</div>
    </div>
  </div>
  <div class="container py-4">
    <h1 class="mb-4">Financial Tracker</h1>
    <form id="dow-form" class="row g-3 align-items-end mb-4 no-print">
      <div class="col-auto">
        <button type="button" class="btn btn-outline-secondary" id="add-series-btn">+ New Series</button>
      </div>
      <div class="col-auto">
        <label for="series" class="form-label">Series Name</label>
        <select id="series" class="form-select"></select>
      </div>
      <div class="col-auto">
        <label for="date" class="form-label">Date</label>
        <input type="date" id="date" class="form-control" required>
      </div>
      <div class="col-auto">
        <label for="value" class="form-label">Daily Closing Value</label>
        <input type="number" id="value" class="form-control" step="0.01" required>
      </div>
      <div class="col-auto">
        <button type="submit" class="btn btn-primary">Add Value</button>
      </div>
      <div class="col-auto ms-auto no-print">
        <div class="btn-group">
          <button type="button" class="btn btn-success dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
            Data
          </button>
          <ul class="dropdown-menu">
            <li>
              <a class="dropdown-item" href="#" id="print-menu">Print Chart</a>
            </li>
            <li>
              <a class="dropdown-item" href="#" id="download-json-menu">Download JSON</a>
            </li>
            <li>
              <a class="dropdown-item" href="#" id="upload-json-menu">Upload JSON</a>
              <input type="file" id="upload-json-input" accept="application/json" style="display:none;">
            </li>
            <li>
              <hr class="dropdown-divider">
            </li>
            <li>
              <button class="dropdown-item text-danger" id="clear-data-btn" type="button">Clear Data</button>
            </li>
          </ul>
        </div>
      </div>
    </form>

    <!-- Replace single chart canvas with a container for multiple charts -->
    <div class="mb-4" id="charts-container"></div>

    <div class="mb-3 d-flex justify-content-center align-items-center" id="chart-range-controls">
      <label for="chart-from" class="me-2 mb-0">From</label>
      <input type="date" id="chart-from" class="form-control mx-2" style="width:auto;">
      <label for="chart-to" class="me-2 mb-0">To</label>
      <input type="date" id="chart-to" class="form-control mx-2" style="width:auto;">
      <button type="button" class="btn btn-primary ms-2" id="chart-range-apply">Apply</button>
    </div>

    <h3 id="values-heading" class="no-print"></h3>
    <table class="table table-striped no-print">
      <thead>
        <tr>
          <th>Date</th>
          <th>Dow Close</th>
        </tr>
      </thead>
      <tbody id="values-table">
        <!-- Values will be inserted here -->
      </tbody>
    </table>
  </div>

  <!-- Earliest Date Modal -->
<div class="modal fade" id="earliestDateModal" tabindex="-1" aria-labelledby="earliestDateLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="earliestDateLabel">Select Earliest Date for Dow Jones Industrial Average data import</h5>
      </div>
      <div class="modal-body">
        <label for="earliest-date-input" class="form-label">Earliest Date</label>
        <input type="date" id="earliest-date-input" class="form-control">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="earliest-date-ok">OK</button>
      </div>
    </div>
  </div>
</div>

  <script>
    // --- Series Management ---
const SERIES_LIST_KEY = 'series_list';
const DOW_SERIES = 'Dow Jones';

// Get all series names
function getSeriesList() {
  return JSON.parse(localStorage.getItem(SERIES_LIST_KEY) || `["${DOW_SERIES}"]`);
}

// Save all series names
function saveSeriesList(list) {
  localStorage.setItem(SERIES_LIST_KEY, JSON.stringify(list));
}

// Get values for a series
function getSeriesValues(series) {
  if (series === DOW_SERIES) return getValues();
  return JSON.parse(localStorage.getItem('series_' + series) || '[]');
}

// Save values for a series
function saveSeriesValues(series, values) {
  if (series === DOW_SERIES) return saveValues(values);
  localStorage.setItem('series_' + series, JSON.stringify(values));
}

// Populate series dropdown
function populateSeriesDropdown(selected) {
  const list = getSeriesList().filter(name => name !== DOW_SERIES); // Exclude Dow Jones
  const sel = document.getElementById('series');
  sel.innerHTML = '';
  list.forEach(name => {
    const opt = document.createElement('option');
    opt.value = name;
    opt.textContent = name;
    sel.appendChild(opt);
  });
  sel.value = selected && list.includes(selected) ? selected : list[0] || '';
}

// Add new series
document.getElementById('add-series-btn').addEventListener('click', () => {
  let name = prompt('Enter a name for the new series:');
  if (!name) return;
  name = name.trim();
  if (!name) return;
  const list = getSeriesList();
  if (list.includes(name)) {
    alert('A series with this name already exists.');
    return;
  }
  list.push(name);
  saveSeriesList(list);
  saveSeriesValues(name, []);
  populateSeriesDropdown(name);
  render();
});

function updateFormState() {
  const sel = document.getElementById('series');
  const hasSeries = !!sel.value;
  document.getElementById('series').disabled = !hasSeries;
  document.getElementById('date').disabled = !hasSeries;
  document.getElementById('value').disabled = !hasSeries;
  document.querySelector('button[type="submit"]').disabled = !hasSeries;
}

// Call after populating dropdown and on change
populateSeriesDropdown();
updateFormState();

// Update dropdown on load
populateSeriesDropdown();

// Update table/chart when series changes
document.getElementById('series').addEventListener('change', () => {
  render();
  updateFormState();
});

// --- Chart date range state ---
let chartFrom, chartTo;

// Set default date range: from = 2 months ago, to = today
function setDefaultChartRange() {
  const today = new Date();
  const to = today.toISOString().slice(0, 10);
  const fromDate = new Date(today);
  fromDate.setMonth(fromDate.getMonth() - 2);
  const from = fromDate.toISOString().slice(0, 10);
  document.getElementById('chart-from').value = from;
  document.getElementById('chart-to').value = to;
  chartFrom = from;
  chartTo = to;
}

// Listen for changes to date range controls
document.getElementById('chart-range-apply').addEventListener('click', () => {
  chartFrom = document.getElementById('chart-from').value;
  chartTo = document.getElementById('chart-to').value;
  render();
});

// Set defaults on page load
setDefaultChartRange();

// Utilities for localStorage
const STORAGE_KEY = 'dow_values';

function getValues() {
  return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
}

function saveValues(values) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(values));
}

// Remove single chart logic and add multi-chart rendering
const chartInstances = {}; // Store Chart.js instances by series name

async function render() {
  const seriesList = getSeriesList();
  const selectedSeries = document.getElementById('series').value;
  updateFormState();

  // Update heading
  document.getElementById('values-heading').textContent = `Daily Values for ${selectedSeries}`;

  // Table: show only selected series
  const values = getSeriesValues(selectedSeries).sort((a, b) => a.date.localeCompare(b.date));
  const table = document.getElementById('values-table');
  table.innerHTML = values.map(v =>
    `<tr><td>${v.date}</td><td>${Number(v.value).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td></tr>`
  ).join('');

  // Chart: show each series in its own chart
  const chartsContainer = document.getElementById('charts-container');
  chartsContainer.innerHTML = '';
  chartsContainer.className = ''; // Remove Bootstrap row for grid

  // Helper for colors
  function getColor(idx) {
    const colors = [
      'rgba(13,110,253,1)', // blue
      'rgba(220,53,69,1)',  // red
      'rgba(40,167,69,1)',  // green
      'rgba(255,193,7,1)',  // yellow
      'rgba(23,162,184,1)', // cyan
      'rgba(108,117,125,1)',// gray
      'rgba(111,66,193,1)', // purple
    ];
    return colors[idx % colors.length];
  }

  // Destroy previous chart instances
  Object.values(chartInstances).forEach(chart => {
    try { chart.destroy(); } catch (e) {}
  });
  Object.keys(chartInstances).forEach(k => delete chartInstances[k]);

  seriesList.forEach((name, idx) => {
    // Create a wrapper for each chart (vertical stacking)
    const wrapper = document.createElement('div');
    wrapper.className = 'mb-2';

    // Add a small heading for each chart
    const heading = document.createElement('h6');
    heading.textContent = name;
    heading.className = 'mb-1';
    wrapper.appendChild(heading);

    // Create canvas for chart
    const canvas = document.createElement('canvas');
    canvas.height = 180; // keep reduced height
    canvas.style.width = '100%';
    wrapper.appendChild(canvas);

    chartsContainer.appendChild(wrapper);

    // Prepare data
    const data = getSeriesValues(name)
      .filter(v => (!chartFrom || v.date >= chartFrom) && (!chartTo || v.date <= chartTo))
      .map(v => ({ x: v.date, y: v.value }))
      .sort((a, b) => a.x.localeCompare(b.x));

    // Create chart
    chartInstances[name] = new Chart(canvas.getContext('2d'), {
      type: 'line',
      data: {
        datasets: [{
          label: name,
          data,
          borderColor: getColor(idx),
          backgroundColor: getColor(idx).replace('1)', '0.1)'),
          fill: false,
          tension: 0.2
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false }
        },
        scales: {
          x: {
            title: { display: true, text: 'Date' },
            type: 'time',
            time: { unit: 'day' }
          },
          y: { title: { display: true, text: 'Value' } }
        }
      }
    });
  });
}

// Show/hide spinner
function showSpinner(show) {
  document.getElementById('spinner').classList.toggle('hidden', !show);
}

// Helper to format date as YYYY-MM-DD
function formatDate(d) {
  return d.toISOString().slice(0, 10);
}

const FMP_API_KEY = 'ksnyJJle3CIgsIeWqvDsDbRPYM0wb96V';
// Fetch all Dow data from FMP and filter by missing dates
async function fetchDowMissing(existingDatesSet) {
  const url = `https://financialmodelingprep.com/stable/historical-price-eod/full?symbol=^DJI&apikey=${FMP_API_KEY}`;
  try {
    const res = await fetch(url);
    const data = await res.json();
    if (!Array.isArray(data)) throw new Error('No data');
    // Only return entries not already in local data
    return data
      .filter(d => !existingDatesSet.has(d.date))
      .map(d => ({
        date: d.date,
        value: d.close
      }));
  } catch (e) {
    console.log('No Dow data retrieved:', e);
    return [];
  }
}

// Get earliest date from user using modal
async function getEarliestDateFromUser(defaultDate) {
  return new Promise(resolve => {
    const modal = new bootstrap.Modal(document.getElementById('earliestDateModal'));
    const input = document.getElementById('earliest-date-input');
    input.value = defaultDate;
    document.getElementById('earliest-date-ok').onclick = () => {
      modal.hide();
      resolve(input.value || defaultDate);
    };
    modal.show();
  });
}

// On page load: fetch if not already in localStorage, or update with missing days
async function init() {
  showSpinner(true);
  let values = getValues();
  const existingDates = new Set(values.map(v => v.date));
  const missing = await fetchDowMissing(existingDates);

  if (!values.length && missing.length) {
    // Use modal datepicker instead of prompt
    const defaultDate = (() => {
      const d = new Date();
      d.setFullYear(d.getFullYear() - 1);
      return d.toISOString().slice(0, 10);
    })();
    showSpinner(false); // Hide spinner before showing modal
    const earliest = await getEarliestDateFromUser(defaultDate);
    showSpinner(true); // Show spinner again while processing
    values = missing.filter(v => v.date >= earliest);
    values.sort((a, b) => a.date.localeCompare(b.date));
    saveValues(values);
  } else if (missing.length) {
    values = values.concat(missing);
    values.sort((a, b) => a.date.localeCompare(b.date));
    saveValues(values);
  }

  await render();
  showSpinner(false);
}

// Form handler
document.getElementById('dow-form').addEventListener('submit', function(e) {
  e.preventDefault();
  const series = document.getElementById('series').value;
  const date = document.getElementById('date').value;
  let value = parseFloat(document.getElementById('value').value);
  if (!date || isNaN(value)) return;
  // Truncate to two decimals
  value = Math.trunc(value * 100) / 100;
  let values = getSeriesValues(series);

  // Check for existing entry for this date (only for custom series)
  if (series !== DOW_SERIES) {
    const existing = values.find(v => v.date === date);
    if (existing) {
      const ok = confirm(`A value for ${date} already exists in "${series}". Replace it?`);
      if (!ok) return;
    }
  }

  // Remove existing entry for this date
  values = values.filter(v => v.date !== date);
  values.push({ date, value });
  saveSeriesValues(series, values);
  render();
  this.reset();
});

// Initial load
init();

document.getElementById('download-json-menu').addEventListener('click', (e) => {
  e.preventDefault();
  // Gather all series data
  const allSeries = {};
  const seriesList = getSeriesList();
  seriesList.forEach(name => {
    allSeries[name] = getSeriesValues(name);
  });

  // Create JSON blob
  const blob = new Blob([JSON.stringify(allSeries, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);

  // Create a temporary link and click it
  const a = document.createElement('a');
  a.href = url;
  a.download = 'financial-tracker-data.json';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
});

// Handle JSON upload
document.getElementById('upload-json-menu').addEventListener('click', (e) => {
  e.preventDefault();
  document.getElementById('upload-json-input').click();
});

document.getElementById('upload-json-input').addEventListener('change', function() {
  const file = this.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(evt) {
    try {
      const data = JSON.parse(evt.target.result);

      // Validate: must be an object with keys matching series names, and each value an array of {date, value}
      if (
        typeof data !== 'object' || Array.isArray(data) || !data ||
        !Object.values(data).every(arr =>
          Array.isArray(arr) &&
          arr.every(
            v =>
              typeof v === 'object' &&
              typeof v.date === 'string' &&
              typeof v.value === 'number'
          )
        )
      ) {
        throw new Error();
      }

      // Overwrite all series data
      const seriesNames = Object.keys(data);
      saveSeriesList(seriesNames);
      seriesNames.forEach(name => {
        // Truncate all imported values to two decimals
        const fixed = data[name].map(v => ({
          date: v.date,
          value: Math.trunc(v.value * 100) / 100
        }));
        saveSeriesValues(name, fixed);
      });
      populateSeriesDropdown(seriesNames[0]);
      render();
      alert('Data imported successfully!');
    } catch {
      alert('Invalid data format. Please upload a valid exported JSON file.');
    }
    this.value = '';
  }.bind(this);
  reader.readAsText(file);
});

// Clear data button
document.getElementById('clear-data-btn').addEventListener('click', () => {
  if (confirm('WARNING: This will permanently delete ALL your data. Are you sure you want to continue?')) {
    // Remove all series data and reset to just Dow Jones
    const seriesList = getSeriesList();
    seriesList.forEach(name => {
      if (name === DOW_SERIES) {
        saveValues([]);
      } else {
        localStorage.removeItem('series_' + name);
      }
    });
    saveSeriesList([DOW_SERIES]);
    populateSeriesDropdown(DOW_SERIES);
    render();
    alert('All data has been cleared.');
  }
});

// Print chart menu item
document.getElementById('print-menu').addEventListener('click', function(e) {
  e.preventDefault();
  window.print();
});
  </script>

  <!-- Bootstrap JS (required for modals) and Popper.js -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"></script>
</body>
</html>